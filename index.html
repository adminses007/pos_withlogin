<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System - Product Management</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-store"></i> POS System</h1>
                    <p>Professional product management and inventory control system</p>
                </div>
                <div class="header-right">
                    <div class="user-info" id="userInfo">
                        <span class="username" id="currentUser">Not logged in</span>
                        <span class="role" id="currentRole"></span>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="showUserManagement()" id="userManagementBtn" style="display: none;">
                            <i class="fas fa-users"></i>
                            User Management
                        </button>
                        <button class="btn btn-secondary" onclick="showChangePassword()">
                            <i class="fas fa-key"></i>
                            Change Password
                        </button>
                        <button class="btn btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-products">0</div>
                <div class="stat-label">Total Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-value">$0</div>
                <div class="stat-label">Total Inventory Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="low-stock-count">0</div>
                <div class="stat-label">Low Stock Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-profit">0%</div>
                <div class="stat-label">Average Profit Margin</div>
            </div>
        </div>

        <!-- 产品管理卡片 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-box"></i>
                Product Management
            </div>
            
            <!-- 产品表单 -->
            <div class="form-container">
                <div class="form-group">
                    <label for="barcode">Barcode</label>
                    <input type="text" id="barcode" placeholder="Enter product barcode">
                </div>
                <div class="form-group">
                    <label for="name">Product Name</label>
                    <input type="text" id="name" placeholder="Enter product name">
                </div>
                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="">Select Category</option>
                        <option value="Food">Food</option>
                        <option value="Drinks">Drinks</option>
                        <option value="Daily Necessities">Daily Necessities</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity">Stock Quantity</label>
                    <input type="number" id="quantity" placeholder="Enter stock quantity">
                </div>
                <div class="form-group">
                    <label for="cost_price">Cost Price</label>
                    <input type="number" id="cost_price" step="0.01" placeholder="Enter cost price">
                </div>
                <div class="form-group">
                    <label for="selling_price">Selling Price</label>
                    <input type="number" id="selling_price" step="0.01" placeholder="Enter selling price">
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="btn-group">
                <button class="btn btn-primary" onclick="addProduct()">
                    <i class="fas fa-plus"></i>
                    Add Product
                </button>
                <button class="btn btn-warning" onclick="modifyProduct()">
                    <i class="fas fa-edit"></i>
                    Modify Product
                </button>
                <button class="btn btn-danger" onclick="deleteProduct()">
                    <i class="fas fa-trash"></i>
                    Delete Product
                </button>
                <button class="btn btn-info" onclick="showLowStockSettings()">
                    <i class="fas fa-exclamation-triangle"></i>
                    Low Stock Settings
                </button>
                <button class="btn btn-warning" onclick="showProfitCalculator()">
                    <i class="fas fa-calculator"></i>
                    Profit Calculator
                </button>
                <button class="btn btn-secondary" onclick="clearInputs()">
                    <i class="fas fa-eraser"></i>
                    Clear Form
                </button>
            </div>
        </div>

        <!-- 数据管理 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-database"></i>
                Data Management
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="goToTempPOS()">
                    <i class="fas fa-cash-register"></i>
                    Cashier Sales
                </button>
                <button class="btn btn-secondary" onclick="goToPOS()">
                    <i class="fas fa-shopping-cart"></i>
                    Sales Management
                </button>
            </div>
        </div>

        <!-- 搜索和过滤 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-search"></i>
                Search and Filter
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search product name or barcode...">
                </div>
                <select id="categoryFilter" class="form-group">
                    <option value="">All Categories</option>
                    <option value="Food">Food</option>
                    <option value="Drinks">Drinks</option>
                    <option value="Daily Necessities">Daily Necessities</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Clothing">Clothing</option>
                    <option value="Other">Other</option>
                </select>
                <button class="btn btn-primary" onclick="filterProducts()">
                    <i class="fas fa-filter"></i>
                    Filter
                </button>
                <button class="btn btn-secondary" onclick="resetFilter()">
                    <i class="fas fa-undo"></i>
                    Reset
                </button>
            </div>
        </div>

        <!-- 产品列表 -->
        <div class="card">
            <div class="card-title">
                <i class="fas fa-list"></i>
                Product List
            </div>
            
            <!-- 固定表头 -->
            <div class="fixed-header">
                <table class="header-table">
                    <tr>
                        <th>No.</th>
                        <th>Barcode</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Stock Quantity</th>
                        <th>Cost Price</th>
                        <th>Selling Price</th>
                        <th>Profit Margin</th>
                        <th>Low Stock Threshold</th>
                        <th>Status</th>
                    </tr>
                </table>
            </div>
            
            <!-- 可滚动的表格内容 -->
            <div class="table-container">
                <table class="content-table">
                    <tbody id="product_table"></tbody>
                </table>
            </div>
        </div>
    </div>



    <!-- 通知容器 -->
    <div id="notification-container"></div>

    <!-- 低库存设置模态框 -->
    <div id="lowStockModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 80%; max-height: 80%; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Low Stock Settings</h2>
                <span class="close" onclick="closeLowStockModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-controls">
                    <div class="form-group">
                        <label for="globalLowStockThreshold">Global Low Stock Threshold</label>
                        <input type="number" id="globalLowStockThreshold" placeholder="Enter global threshold" min="0">
                        <button class="btn btn-primary" onclick="setGlobalThreshold()">
                            <i class="fas fa-save"></i>
                            Set Global Threshold
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="categoryLowStockThreshold">Category Low Stock Threshold</label>
                        <div class="category-threshold-controls">
                            <select id="categorySelector" onchange="loadCategoryThreshold()">
                                <option value="">Select Category</option>
                            </select>
                            <input type="number" id="categoryLowStockThreshold" placeholder="Enter category threshold" min="0">
                            <button class="btn btn-info" onclick="setCategoryThreshold()">
                                <i class="fas fa-tags"></i>
                                Set Category Threshold
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="product-settings">
                    <h3>Individual Product Settings</h3>
                    <div class="search-controls">
                        <div class="search-box">
                            <input type="text" id="lowStockSearchInput" placeholder="Search by barcode or product name..." oninput="filterLowStockProducts()">
                            <button class="btn btn-secondary" onclick="clearLowStockSearch()">
                                <i class="fas fa-undo"></i>
                                Clear
                            </button>
                        </div>
                        <div class="filter-controls">
                            <select id="lowStockStatusFilter" onchange="filterLowStockProducts()">
                                <option value="">All Status</option>
                                <option value="low">Low Stock Only</option>
                                <option value="ok">OK Status Only</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Barcode</th>
                                    <th>Product Name</th>
                                    <th>Current Stock</th>
                                    <th>Low Stock Threshold</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 利润计算器模态框 -->
    <div id="profitCalculatorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-calculator"></i> Profit Calculator</h2>
                <span class="close" onclick="closeProfitCalculator()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="profit-calculator">
                    <div class="form-group">
                        <label for="costPriceForMargin">Cost Price:</label>
                        <input type="number" id="costPriceForMargin" placeholder="Enter cost price" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="profitMargin">Profit Margin (%):</label>
                        <input type="number" id="profitMargin" placeholder="Enter profit margin percentage" step="0.01" min="0" max="100">
                    </div>
                    
                    <div class="form-group">
                        <label for="sellingPriceForCost">Selling Price:</label>
                        <input type="number" id="sellingPriceForCost" placeholder="Enter selling price" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="costPriceForCost">Cost Price:</label>
                        <input type="number" id="costPriceForCost" placeholder="Enter cost price" step="0.01" min="0">
                    </div>
                    
                    <div class="calculation-mode">
                        <label>Calculation Mode:</label>
                        <div class="mode-buttons">
                            <button type="button" class="mode-btn active" onclick="setCalculationMode('margin')">By Margin</button>
                            <button type="button" class="mode-btn" onclick="setCalculationMode('cost')">By Cost</button>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="calculateProfit()">
                            <i class="fas fa-calculator"></i>
                            Calculate
                        </button>

                        <button class="btn btn-success" onclick="applyToForm()">
                            <i class="fas fa-check"></i>
                            Apply to Form
                        </button>
                    </div>
                    
                    <div class="calculation-result" id="profitOutput">
                        <!-- 计算结果将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户管理模态框 -->
    <div id="userManagementModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 80%; max-height: 80%; overflow-y: auto;">
            <div class="modal-header">
                <h2><i class="fas fa-users"></i> User Management</h2>
                <span class="close" onclick="closeUserManagement()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="user-management-controls">
                    <button class="btn btn-primary" onclick="showAddUserForm()">
                        <i class="fas fa-plus"></i>
                        Add User
                    </button>
                </div>
                
                <div class="user-list">
                    <h3>User List</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Created At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="userTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div id="addUserModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> Add User</h2>
                <span class="close" onclick="closeAddUser()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" placeholder="Enter username">
                </div>
                <div class="form-group">
                    <label for="newPassword">Password</label>
                    <input type="password" id="newPassword" placeholder="Enter password">
                </div>
                <div class="form-group">
                    <label for="newRole">Role</label>
                    <select id="newRole">
                        <option value="">Select role</option>
                        <option value="root">Root Admin</option>
                        <option value="admin">Admin Admin</option>
                        <option value="user">User User</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addUser()">
                        <i class="fas fa-save"></i>
                        Add User
                    </button>
                    <button class="btn btn-secondary" onclick="closeAddUser()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-key"></i> Change Password</h2>
                <span class="close" onclick="closeChangePassword()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="oldPassword">Current Password</label>
                    <input type="password" id="oldPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="newPasswordChange">New Password</label>
                    <input type="password" id="newPasswordChange" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input type="password" id="confirmPassword" placeholder="Enter new password again">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="changePassword()">
                        <i class="fas fa-save"></i>
                        Change Password
                    </button>
                    <button class="btn btn-secondary" onclick="closeChangePassword()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            background-color: #f8fafc;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1f2937;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .settings-controls {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .settings-controls .form-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .settings-controls input {
            flex: 1;
            max-width: 200px;
        }
        
        .category-threshold-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .category-threshold-controls select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            font-size: 14px;
            min-width: 150px;
        }
        
        .category-threshold-controls input {
            flex: 1;
            max-width: 150px;
        }
        
        .product-settings h3 {
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .low-stock-warning {
            color: #ef4444;
            font-weight: bold;
        }
        
        .low-stock-ok {
            color: #10b981;
            font-weight: bold;
        }
        
        .threshold-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        
        .search-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .search-box input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .filter-controls select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background-color: white;
            font-size: 14px;
            min-width: 150px;
        }
        
        .filter-controls select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Product List 滚动条样式 */
        .card .table-container {
            max-height: 600px; /* 设置最大高度，大约显示15行 */
            overflow-y: auto;
            overflow-x: auto;
            position: relative;
        }
        
        .card .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .card .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .card .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .card .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        

        
        /* 确保表格行有合适的高度 */
        .card .table-container tbody tr {
            height: 40px; /* 每行大约40px高度 */
        }
        
        .card .table-container tbody td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* 固定表头样式 */
        .fixed-header {
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 0;
        }
        
        .header-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .header-table th {
            padding: 12px 8px;
            font-weight: 600;
            color: #374151;
            text-align: left;
            background: #f8fafc;
            border-bottom: 2px solid #e5e7eb;
        }
        
        /* 内容表格样式 */
        .content-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .content-table td {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* 确保表头和内容表格列宽一致 */
        .header-table th:nth-child(1),
        .content-table td:nth-child(1) { width: 5%; } /* No. */
        
        .header-table th:nth-child(2),
        .content-table td:nth-child(2) { width: 12%; } /* Barcode */
        
        .header-table th:nth-child(3),
        .content-table td:nth-child(3) { width: 20%; } /* Product Name */
        
        .header-table th:nth-child(4),
        .content-table td:nth-child(4) { width: 12%; } /* Category */
        
        .header-table th:nth-child(5),
        .content-table td:nth-child(5) { width: 10%; } /* Stock Quantity */
        
        .header-table th:nth-child(6),
        .content-table td:nth-child(6) { width: 10%; } /* Cost Price */
        
        .header-table th:nth-child(7),
        .content-table td:nth-child(7) { width: 10%; } /* Selling Price */
        
        .header-table th:nth-child(8),
        .content-table td:nth-child(8) { width: 10%; } /* Profit Margin */
        
        .header-table th:nth-child(9),
        .content-table td:nth-child(9) { width: 11%; } /* Status */
        
        /* 利润计算器样式 */
        .profit-calculator {
            padding: 20px 0;
        }
        
        .profit-calculator .form-group {
            margin-bottom: 20px;
        }
        
        .profit-calculator label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .profit-calculator input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .profit-calculator input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .profit-calculator .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .profit-calculator .btn-group .btn {
            flex: 1;
        }
        
        .calculation-result {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .calculation-result h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 18px;
        }
        
        .calculation-result .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calculation-result .result-item:last-child {
            border-bottom: none;
        }
        
        .calculation-result .result-label {
            font-weight: 600;
            color: #374151;
        }
        
        .calculation-result .result-value {
            font-size: 18px;
            font-weight: bold;
            color: #10b981;
        }
        
        .calculation-result .result-value.profit {
            color: #10b981;
        }
        
        .calculation-result .result-value.cost {
            color: #ef4444;
        }
        
        /* 计算模式样式 */
        .calculation-mode {
            margin-bottom: 20px;
        }
        
        .calculation-mode label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        .mode-buttons {
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .mode-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .mode-btn:hover {
            background: #e5e7eb;
        }
        
        .mode-btn.active:hover {
            background: #2563eb;
        }
        
        /* 头部样式 */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .username {
            font-weight: 600;
            color: #1f2937;
            font-size: 16px;
        }
        
        .role {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .user-actions .btn {
            padding: 8px 12px;
            font-size: 14px;
        }
        
        /* 用户管理样式 */
        .user-management-controls {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .user-list h3 {
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .user-list .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-list table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .user-list th,
        .user-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .user-list th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #374151;
        }
        
        .user-list tr:hover {
            background-color: #f9fafb;
        }
        
        .user-actions-cell {
            display: flex;
            gap: 8px;
        }
        
        .user-actions-cell .btn {
            padding: 4px 8px;
            font-size: 12px;
        }
        
        /* 确保表格内容不会覆盖表头 */
        .card .table-container tbody {
            position: relative;
            z-index: 1;
        }
        
        /* 额外的固定表头设置 */
        .card .table-container table thead {
            position: sticky !important;
            top: 0 !important;
            background: #f8fafc !important;
            z-index: 999 !important;
        }
        
        .card .table-container table thead tr {
            position: sticky !important;
            top: 0 !important;
            background: #f8fafc !important;
            z-index: 999 !important;
        }
        
        .card .table-container table thead th {
            position: sticky !important;
            top: 0 !important;
            background: #f8fafc !important;
            z-index: 999 !important;
        }
        
        /* 专门针对Product List的固定表头 */
        .card:has(.card-title:contains("Product List")) .table-container thead,
        .card .card-title:has(i.fas.fa-list) + .table-container thead {
            position: sticky !important;
            top: 0 !important;
            background: #f8fafc !important;
            z-index: 999 !important;
        }
        
        .card:has(.card-title:contains("Product List")) .table-container thead tr,
        .card .card-title:has(i.fas.fa-list) + .table-container thead tr {
            position: sticky !important;
            top: 0 !important;
            background: #f8fafc !important;
            z-index: 999 !important;
        }
        
        .card:has(.card-title:contains("Product List")) .table-container thead th,
        .card .card-title:has(i.fas.fa-list) + .table-container thead th {
            position: sticky !important;
            top: 0 !important;
            background: #f8fafc !important;
            z-index: 999 !important;
        }
        

    </style>

    <script>
        let products = [];
        let selectedRowId = null;
        let filteredProducts = [];
        let currentUser = null;
        let authToken = null;

        const lowStockThreshold = 10; // 低库存阈值
        
        // API基础URL
        const API_BASE = 'http://localhost:5000/api';
        
        // 页面加载时检查登录状态
        window.addEventListener('load', function() {
            checkAuth();
        });
        
        // 检查登录状态
        function checkAuth() {
            const user = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!user || !token) {
                // 未登录，重定向到登录页面
                window.location.href = '/login.html';
                return;
            }
            
            try {
                currentUser = JSON.parse(user);
                authToken = token;
                
                // 验证token是否有效
                validateToken();
            } catch (error) {
                console.error('Error parsing user data:', error);
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }
        
        // 验证token
        async function validateToken() {
            try {
                const response = await fetch(`${API_BASE}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // token有效，更新用户信息
                    currentUser = result.data;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    // 检查权限
                    if (currentUser.role !== 'root') {
                        // 非root用户不能访问产品管理页面
                        showNotification('Insufficient permissions, redirecting...', 'error');
                        setTimeout(() => {
                            if (currentUser.role === 'admin') {
                                window.location.href = '/pos.html';
                            } else {
                                window.location.href = '/temp_pos.html';
                            }
                        }, 2000);
                        return;
                    }
                    
                    // 显示用户信息
                    displayUserInfo();
                    
                    // 加载数据
                    loadProducts();
                    setupEventListeners();
                } else {
                    // token无效
                    localStorage.removeItem('user');
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Error validating token:', error);
                localStorage.removeItem('user');
                localStorage.removeItem('token');
                window.location.href = '/login.html';
            }
        }
        
        // 显示用户信息
        function displayUserInfo() {
            document.getElementById('currentUser').textContent = currentUser.username;
            
            let roleText = '';
            switch (currentUser.role) {
                case 'root':
                    roleText = 'Root administrator';
                    document.getElementById('userManagementBtn').style.display = 'inline-block';
                    break;
                case 'admin':
                    roleText = 'Admin administrator';
                    break;
                case 'user':
                    roleText = 'User user';
                    break;
            }
            
            document.getElementById('currentRole').textContent = roleText;
        }
        
        // 退出登录
        async function logout() {
            try {
                await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
            } catch (error) {
                console.error('Error during logout:', error);
            }
            
            // 清除本地存储
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            
            // 重定向到登录页面
            window.location.href = '/login.html';
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 搜索框实时搜索
            document.getElementById('searchInput').addEventListener('input', function() {
                filterProducts();
            });
            
            // 类别过滤
            document.getElementById('categoryFilter').addEventListener('change', function() {
                filterProducts();
            });
            
            // 回车键提交表单
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
                    addProduct();
                }
            });
        }
        
        // 显示通知
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            container.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // 从API加载产品数据
        async function loadProducts() {
            try {
                showNotification('Loading product data...', 'info');
                const response = await fetch(`${API_BASE}/products`);
                const result = await response.json();
                if (result.success) {
                    products = result.data;
                    filteredProducts = [...products];
                    refreshTable();
                    updateStats();
                    showNotification('Product data loaded successfully');
                } else {
                    showNotification('Failed to load product: ' + result.error, 'error');
                }
            } catch (error) {
            console.error('Error loading product:', error);
                showNotification('Error loading product, please check your network connection', 'error');
            }
        }

        // 更新统计信息
        function updateStats() {
            const totalProducts = products.length;
            const lowStockCount = products.filter(p => p.quantity <= lowStockThreshold).length;
            
            let totalValue = 0;
            let totalProfit = 0;
            let totalSellingValue = 0;
            
            products.forEach(product => {
                totalValue += product.cost_price * product.quantity;
                totalProfit += (product.selling_price - product.cost_price) * product.quantity;
                totalSellingValue += product.selling_price * product.quantity;
            });
            
            const avgProfit = totalSellingValue > 0 ? (totalProfit / totalSellingValue) * 100 : 0;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('low-stock-count').textContent = lowStockCount;
            document.getElementById('avg-profit').textContent = `${avgProfit.toFixed(1)}%`;
        }
        
        function refreshTable() {
            const table = document.getElementById("product_table");
            table.innerHTML = "";

            if (filteredProducts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No matching products found
                        </td>
                    </tr>
                `;
                return;
            }

            filteredProducts.forEach((product, index) => {
                const isLowStock = product.quantity <= lowStockThreshold;
                const isSelected = selectedRowId === index;
                
                let statusBadge = '';
                if (isLowStock) {
                    statusBadge = '<span class="status-badge status-warning">Low Stock</span>';
                } else if (product.quantity === 0) {
                    statusBadge = '<span class="status-badge status-danger">Out of Stock</span>';
                } else {
                    statusBadge = '<span class="status-badge status-success">In Stock</span>';
                }

                const row = `
                    <tr onclick="selectRow(${index})" class="${isSelected ? 'selected' : ''} ${isLowStock ? 'low-stock' : ''}" style="cursor: pointer;">
                        <td>${index + 1}</td>
                        <td><strong>${product.barcode}</strong></td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.cost_price.toFixed(2)}</td>
                        <td>$${product.selling_price.toFixed(2)}</td>
                        <td>${product.profit_margin.toFixed(1)}%</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }

        // 搜索和过滤功能
        function filterProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            filteredProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.barcode.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                return matchesSearch && matchesCategory;
            });
            
            refreshTable();
        }
        
        // 重置过滤
        function resetFilter() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            filteredProducts = [...products];
            refreshTable();
        }
        
        // 选择某一行商品
        function selectRow(index) {
            selectedRowId = index;
            const product = filteredProducts[selectedRowId];
            // 将商品数据加载到输入框
            document.getElementById("barcode").value = product.barcode;
            document.getElementById("name").value = product.name;
            document.getElementById("category").value = product.category;
            document.getElementById("cost_price").value = product.cost_price;
            document.getElementById("selling_price").value = product.selling_price;
            document.getElementById("quantity").value = product.quantity;
            refreshTable();  // 刷新表格
        }

        // 添加商品
        async function addProduct() {
            const barcode = document.getElementById("barcode").value.trim();
            const name = document.getElementById("name").value.trim();
            const category = document.getElementById("category").value;
            const cost_price = parseFloat(document.getElementById("cost_price").value);
            const selling_price = parseFloat(document.getElementById("selling_price").value);
            const quantity = parseInt(document.getElementById("quantity").value);

            if (!barcode || !name || !category || isNaN(cost_price) || isNaN(selling_price) || isNaN(quantity)) {
                showNotification("Please fill in all required fields", "error");
                return;
            }

            if (cost_price > selling_price) {
                showNotification("Cost price cannot be higher than selling price", "error");
                return;
            } 

            if (quantity < 0) {
                showNotification("Stock quantity cannot be negative", "error");
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barcode, name, category, quantity, cost_price, selling_price
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadProducts(); // 重新加载产品数据
                    clearInputs();
                    showNotification("Product added successfully!");
                } else {
                    showNotification("Add failed: " + result.error, "error");
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showNotification("Error adding product, please check your network connection", "error");
            }
        }

        // 清空输入框
        function clearInputs() {
            document.getElementById("barcode").value = "";
            document.getElementById("name").value = "";
            document.getElementById("category").value = "";
            document.getElementById("quantity").value = "";
            document.getElementById("cost_price").value = "";
            document.getElementById("selling_price").value = "";
            selectedRowId = null;
            showNotification("Form cleared");
        }
        
        // 导航功能
        function goToTempPOS() {
            window.location.href = "/temp_pos.html";
        }
        
        function goToPOS() {
            window.location.href = "/pos.html";
        }

        // 修改商品
        async function modifyProduct() {
            if (selectedRowId === null) {
                showNotification("Please select the product to modify", "error");
                return;
            }

            const barcode = document.getElementById("barcode").value.trim();
            const name = document.getElementById("name").value.trim();
            const category = document.getElementById("category").value;
            const cost_price = parseFloat(document.getElementById("cost_price").value);
            const selling_price = parseFloat(document.getElementById("selling_price").value);
            const quantity = parseInt(document.getElementById("quantity").value);

            if (!barcode || !name || !category || isNaN(cost_price) || isNaN(selling_price) || isNaN(quantity)) {
                showNotification("Please fill in all required fields", "error");
                return;
            }

            if (cost_price > selling_price) {
                    showNotification("Cost price cannot be higher than selling price", "error");
                return;
            }

            try {
                const productId = filteredProducts[selectedRowId].id;
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barcode, name, category, quantity, cost_price, selling_price
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadProducts(); // 重新加载产品数据
                    clearInputs();
                    showNotification("Product modified successfully!");
                } else {
                    showNotification("Modify failed: " + result.error, "error");
                }
            } catch (error) {
                console.error('Error modifying product:', error);
                showNotification("Error modifying product, please check your network connection", "error");
            }
        }

        // 删除商品
        async function deleteProduct() {
            if (selectedRowId === null) {
                showNotification("Please select the product to delete", "error");
                return;
            }

            if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
                return;
            }

            try {
                const productId = filteredProducts[selectedRowId].id;
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadProducts(); // 重新加载产品数据
                    clearInputs();
                    showNotification("Product deleted successfully!");
                } else {
                    showNotification("Delete failed: " + result.error, "error");
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification("Error deleting product, please check your network connection", "error");
            }
        }

        // 低库存设置相关变量
        let lowStockThresholds = {};

        // 显示低库存设置模态框
        function showLowStockSettings() {
            document.getElementById('lowStockModal').style.display = 'block';
            loadLowStockSettings();
        }

        // 关闭低库存设置模态框
        function closeLowStockModal() {
            document.getElementById('lowStockModal').style.display = 'none';
        }

        // 加载低库存设置
        function loadLowStockSettings() {
            // 从localStorage加载低库存阈值设置
            const savedThresholds = localStorage.getItem('lowStockThresholds');
            if (savedThresholds) {
                lowStockThresholds = JSON.parse(savedThresholds);
            }

            // 设置全局阈值
            const globalThreshold = localStorage.getItem('globalLowStockThreshold') || '10';
            document.getElementById('globalLowStockThreshold').value = globalThreshold;

            // 确保所有产品都有阈值设置
            if (products.length > 0) {
                const globalThresholdValue = parseInt(globalThreshold);
                products.forEach(product => {
                    if (!lowStockThresholds[product.barcode]) {
                        lowStockThresholds[product.barcode] = globalThresholdValue;
                    }
                });
                // 保存更新后的阈值
                localStorage.setItem('lowStockThresholds', JSON.stringify(lowStockThresholds));
            }

            // 加载商品类型选择器
            loadCategorySelector();
            
            // 刷新低库存表格
            refreshLowStockTable();
        }

        // 设置全局低库存阈值
        function setGlobalThreshold() {
            const threshold = parseInt(document.getElementById('globalLowStockThreshold').value);
            if (isNaN(threshold) || threshold < 0) {
                showNotification("Please enter a valid threshold value", "error");
                return;
            }

            localStorage.setItem('globalLowStockThreshold', threshold.toString());
            
            // 为所有产品设置全局阈值
            products.forEach(product => {
                lowStockThresholds[product.barcode] = threshold;
            });

            // 保存设置
            localStorage.setItem('lowStockThresholds', JSON.stringify(lowStockThresholds));
            
            refreshLowStockTable();
            updateStats(); // 更新统计信息
            showNotification("Global low stock threshold set successfully!");
        }

        // 加载商品类型选择器
        function loadCategorySelector() {
            const categorySelector = document.getElementById('categorySelector');
            const categories = [...new Set(products.map(product => product.category))].sort();
            
            // 清空现有选项（保留第一个"Select Category"选项）
            categorySelector.innerHTML = '<option value="">Select Category</option>';
            
            // 添加所有商品类型
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelector.appendChild(option);
            });
        }

        // 加载商品类型的当前阈值
        function loadCategoryThreshold() {
            const category = document.getElementById('categorySelector').value;
            if (!category) {
                document.getElementById('categoryLowStockThreshold').value = '';
                return;
            }

            // 从localStorage加载商品类型阈值
            const categoryThresholds = JSON.parse(localStorage.getItem('categoryLowStockThresholds') || '{}');
            const currentThreshold = categoryThresholds[category] || '';
            document.getElementById('categoryLowStockThreshold').value = currentThreshold;
        }

        // 设置商品类型阈值
        function setCategoryThreshold() {
            const category = document.getElementById('categorySelector').value;
            const threshold = parseInt(document.getElementById('categoryLowStockThreshold').value);
            
            if (!category) {
                showNotification("Please select a category", "error");
                return;
            }
            
            if (isNaN(threshold) || threshold < 0) {
                showNotification("Please enter a valid threshold value", "error");
                return;
            }

            // 保存商品类型阈值
            const categoryThresholds = JSON.parse(localStorage.getItem('categoryLowStockThresholds') || '{}');
            categoryThresholds[category] = threshold;
            localStorage.setItem('categoryLowStockThresholds', JSON.stringify(categoryThresholds));
            
            // 为该商品类型的所有产品设置阈值
            products.forEach(product => {
                if (product.category === category) {
                    lowStockThresholds[product.barcode] = threshold;
                }
            });

            // 保存产品阈值
            localStorage.setItem('lowStockThresholds', JSON.stringify(lowStockThresholds));
            
            refreshLowStockTable();
            updateStats(); // 更新统计信息
            showNotification(`Category threshold set successfully for ${category}!`);
        }

        // 刷新低库存表格
        function refreshLowStockTable() {
            const table = document.getElementById('lowStockTable');
            table.innerHTML = '';

            if (products.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-box" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No products found
                        </td>
                    </tr>
                `;
                return;
            }

            products.forEach(product => {
                const threshold = lowStockThresholds[product.barcode] || 10;
                const isLowStock = product.quantity <= threshold;
                const statusClass = isLowStock ? 'low-stock-warning' : 'low-stock-ok';
                const statusText = isLowStock ? 'Low Stock' : 'OK';

                const row = `
                    <tr>
                        <td><strong>${product.barcode}</strong></td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>
                            <input type="number" 
                                   class="threshold-input" 
                                   value="${threshold}" 
                                   min="0"
                                   onchange="updateProductThreshold('${product.barcode}', this.value)">
                        </td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>
                            <button class="btn btn-primary" onclick="setProductThreshold('${product.barcode}')" style="padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fas fa-save"></i>
                            </button>
                        </td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }

        // 更新产品阈值（实时）
        function updateProductThreshold(barcode, value) {
            const threshold = parseInt(value);
            if (!isNaN(threshold) && threshold >= 0) {
                lowStockThresholds[barcode] = threshold;
                localStorage.setItem('lowStockThresholds', JSON.stringify(lowStockThresholds));
                
                // 更新状态显示
                const product = products.find(p => p.barcode === barcode);
                if (product) {
                    const row = event.target.closest('tr');
                    const statusCell = row.querySelector('td:nth-child(5)');
                    const isLowStock = product.quantity <= threshold;
                    
                    statusCell.className = isLowStock ? 'low-stock-warning' : 'low-stock-ok';
                    statusCell.textContent = isLowStock ? 'Low Stock' : 'OK';
                }
            }
        }

        // 设置产品阈值
        function setProductThreshold(barcode) {
            const input = document.querySelector(`input[onchange*="${barcode}"]`);
            const threshold = parseInt(input.value);
            
            if (isNaN(threshold) || threshold < 0) {
                showNotification("Please enter a valid threshold value", "error");
                return;
            }

            lowStockThresholds[barcode] = threshold;
            localStorage.setItem('lowStockThresholds', JSON.stringify(lowStockThresholds));
            
            updateStats(); // 更新统计信息
            showNotification(`Low stock threshold set for product ${barcode}`);
        }

        // 获取产品的低库存阈值
        function getProductLowStockThreshold(barcode) {
            // 首先检查是否有产品特定的阈值
            if (lowStockThresholds[barcode]) {
                return lowStockThresholds[barcode];
            }
            
            // 然后检查商品类型阈值
            const product = products.find(p => p.barcode === barcode);
            if (product) {
                const categoryThresholds = JSON.parse(localStorage.getItem('categoryLowStockThresholds') || '{}');
                if (categoryThresholds[product.category]) {
                    return categoryThresholds[product.category];
                }
            }
            
            // 最后使用全局阈值
            const globalThreshold = localStorage.getItem('globalLowStockThreshold');
            return globalThreshold ? parseInt(globalThreshold) : 10; // 默认阈值为10
        }

        // 检查产品是否为低库存
        function isProductLowStock(product) {
            const threshold = getProductLowStockThreshold(product.barcode);
            return product.quantity <= threshold;
        }

        // 重写updateStats函数以使用自定义阈值
        function updateStats() {
            const totalProducts = products.length;
            
            // 使用自定义阈值计算低库存产品数量
            const lowStockCount = products.filter(product => isProductLowStock(product)).length;
            
            let totalValue = 0;
            let totalProfit = 0;
            let totalSellingValue = 0;
            
            products.forEach(product => {
                totalValue += product.cost_price * product.quantity;
                totalProfit += (product.selling_price - product.cost_price) * product.quantity;
                totalSellingValue += product.selling_price * product.quantity;
            });
            
            const avgProfit = totalSellingValue > 0 ? (totalProfit / totalSellingValue) * 100 : 0;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('low-stock-count').textContent = lowStockCount;
            document.getElementById('avg-profit').textContent = `${avgProfit.toFixed(1)}%`;
        }

        // 重写refreshTable函数以使用自定义阈值
        function refreshTable() {
            const table = document.getElementById("product_table");
            table.innerHTML = "";

            if (filteredProducts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No matching products found
                        </td>
                    </tr>
                `;
                return;
            }

            filteredProducts.forEach((product, index) => {
                const isLowStock = isProductLowStock(product);
                const isSelected = selectedRowId === index;
                
                let statusBadge = '';
                if (isLowStock) {
                    statusBadge = '<span class="status-badge status-warning">Low Stock</span>';
                } else if (product.quantity === 0) {
                    statusBadge = '<span class="status-badge status-danger">Out of Stock</span>';
                } else {
                    statusBadge = '<span class="status-badge status-success">In Stock</span>';
                }

                const row = `
                    <tr onclick="selectRow(${index})" class="${isSelected ? 'selected' : ''} ${isLowStock ? 'low-stock' : ''}" style="cursor: pointer;">
                        <td>${index + 1}</td>
                        <td><strong>${product.barcode}</strong></td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.cost_price.toFixed(2)}</td>
                        <td>$${product.selling_price.toFixed(2)}</td>
                        <td>${product.profit_margin.toFixed(1)}%</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }

        // 页面加载时初始化低库存设置
        window.addEventListener('load', function() {
            loadProducts();
            setupEventListeners();
            loadLowStockSettings(); // 加载低库存设置
        });

        // 利润计算器相关变量
        let calculatedProfit = 0;
        let calculatedCostPrice = 0;
        let calculationMode = 'margin'; // 'margin' or 'cost'

        // 显示利润计算器模态框
        function showProfitCalculator() {
            document.getElementById('profitCalculatorModal').style.display = 'block';
            // 如果表单中有成本价格，自动填充
            const costPrice = document.getElementById('cost_price').value;
            if (costPrice) {
                document.getElementById('costPriceForMargin').value = costPrice;
                document.getElementById('costPriceForCost').value = costPrice;
            }
            // 如果表单中有销售价格，自动填充
            const sellingPrice = document.getElementById('selling_price').value;
            if (sellingPrice) {
                document.getElementById('sellingPriceForCost').value = sellingPrice;
            }
        }

        // 关闭利润计算器模态框
        function closeProfitCalculator() {
            document.getElementById('profitCalculatorModal').style.display = 'none';
            document.getElementById('profitOutput').innerHTML = '';
        }

        // 设置计算模式
        function setCalculationMode(mode) {
            calculationMode = mode;
            
            // 更新按钮状态
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 根据模式显示/隐藏相关输入框
            if (mode === 'margin') {
                document.getElementById('costPriceForMargin').parentElement.style.display = 'block';
                document.getElementById('profitMargin').parentElement.style.display = 'block';
                document.getElementById('sellingPriceForCost').parentElement.style.display = 'none';
                document.getElementById('costPriceForCost').parentElement.style.display = 'none';
            } else {
                document.getElementById('costPriceForMargin').parentElement.style.display = 'none';
                document.getElementById('profitMargin').parentElement.style.display = 'none';
                document.getElementById('sellingPriceForCost').parentElement.style.display = 'block';
                document.getElementById('costPriceForCost').parentElement.style.display = 'block';
            }
            
            // 清空结果
            document.getElementById('profitOutput').innerHTML = '';
        }

        // 计算利润
        function calculateProfit() {
            if (calculationMode === 'margin') {
                const costPrice = parseFloat(document.getElementById('costPriceForMargin').value);
                const profitMargin = parseFloat(document.getElementById('profitMargin').value);
                
                if (isNaN(costPrice) || isNaN(profitMargin) || profitMargin < 0 || profitMargin > 100) {
                    document.getElementById('profitOutput').innerHTML = `
                        <div class="calculation-result">
                            <h3>Error</h3>
                            <p style="color: #ef4444;">Please enter valid values. Profit margin must be between 0-100%.</p>
                        </div>
                    `;
                    return;
                }

                calculatedCostPrice = costPrice;
                // 正确的计算：销售价格 = 成本价 ÷ (1 - 利润率/100)
                const sellingPrice = costPrice / (1 - (profitMargin / 100));
                calculatedProfit = sellingPrice - costPrice;
                
                document.getElementById('profitOutput').innerHTML = `
                    <div class="calculation-result">
                        <h3>Calculation Results</h3>
                        <div class="result-item">
                            <span class="result-label">Cost Price:</span>
                            <span class="result-value cost">$${calculatedCostPrice.toFixed(2)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Profit Margin:</span>
                            <span class="result-value">${profitMargin.toFixed(2)}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Profit Amount:</span>
                            <span class="result-value profit">$${calculatedProfit.toFixed(2)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Selling Price:</span>
                            <span class="result-value">$${sellingPrice.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                const sellingPrice = parseFloat(document.getElementById('sellingPriceForCost').value);
                const costPrice = parseFloat(document.getElementById('costPriceForCost').value);
                
                if (isNaN(sellingPrice) || isNaN(costPrice) || costPrice < 0 || costPrice >= sellingPrice) {
                    document.getElementById('profitOutput').innerHTML = `
                        <div class="calculation-result">
                            <h3>Error</h3>
                            <p style="color: #ef4444;">Please enter valid values. Cost price must be less than selling price.</p>
                        </div>
                    `;
                    return;
                }

                calculatedProfit = (sellingPrice - costPrice);
                calculatedCostPrice = costPrice;
                const profitMargin = ((calculatedProfit / sellingPrice) * 100);
                
                document.getElementById('profitOutput').innerHTML = `
                    <div class="calculation-result">
                        <h3>Calculation Results</h3>
                        <div class="result-item">
                            <span class="result-label">Selling Price:</span>
                            <span class="result-value">$${sellingPrice.toFixed(2)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Cost Price:</span>
                            <span class="result-value cost">$${calculatedCostPrice.toFixed(2)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Profit Amount:</span>
                            <span class="result-value profit">$${calculatedProfit.toFixed(2)}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Profit Margin:</span>
                            <span class="result-value">${profitMargin.toFixed(2)}%</span>
                        </div>
                    </div>
                `;
            }
        }



        // 应用到表单
        function applyToForm() {
            if (calculatedCostPrice > 0) {
                document.getElementById('cost_price').value = calculatedCostPrice.toFixed(2);
                // 根据计算模式决定销售价格
                if (calculationMode === 'margin') {
                    // By Margin模式：计算销售价格
                    const sellingPrice = calculatedCostPrice + calculatedProfit;
                    document.getElementById('selling_price').value = sellingPrice.toFixed(2);
                } else {
                    // By Cost模式：使用输入的销售价格和成本价
                    const sellingPrice = parseFloat(document.getElementById('sellingPriceForCost').value);
                    const costPrice = parseFloat(document.getElementById('costPriceForCost').value);
                    document.getElementById('selling_price').value = sellingPrice.toFixed(2);
                    document.getElementById('cost_price').value = costPrice.toFixed(2);
                }
                closeProfitCalculator();
                showNotification("Profit calculation applied to form successfully!");
            } else {
                showNotification("Please calculate profit first", "error");
            }
        }
        

        
        // 在表格刷新后重新应用固定表头
        function refreshTable() {
            const table = document.getElementById("product_table");
            table.innerHTML = "";

            if (filteredProducts.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No matching products found
                        </td>
                    </tr>
                `;
                return;
            }

            filteredProducts.forEach((product, index) => {
                const isLowStock = isProductLowStock(product);
                const isSelected = selectedRowId === index;
                
                let statusBadge = '';
                if (isLowStock) {
                    statusBadge = '<span class="status-badge status-warning">Low Stock</span>';
                } else if (product.quantity === 0) {
                    statusBadge = '<span class="status-badge status-danger">Out of Stock</span>';
                } else {
                    statusBadge = '<span class="status-badge status-success">In Stock</span>';
                }

                const row = `
                    <tr onclick="selectRow(${index})" class="${isSelected ? 'selected' : ''} ${isLowStock ? 'low-stock' : ''}" style="cursor: pointer;">
                        <td>${index + 1}</td>
                        <td><strong>${product.barcode}</strong></td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${product.quantity}</td>
                        <td>$${product.cost_price.toFixed(2)}</td>
                        <td>$${product.selling_price.toFixed(2)}</td>
                        <td>${product.profit_margin.toFixed(1)}%</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
                table.innerHTML += row;
            });
            

        }

        // 低库存产品搜索和过滤相关变量
        let filteredLowStockProducts = [];

        // 过滤低库存产品
        function filterLowStockProducts() {
            const searchTerm = document.getElementById('lowStockSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('lowStockStatusFilter').value;
            
            filteredLowStockProducts = products.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.barcode.toLowerCase().includes(searchTerm);
                
                const threshold = lowStockThresholds[product.barcode] || 10;
                const isLowStock = product.quantity <= threshold;
                
                let matchesStatus = true;
                if (statusFilter === 'low') {
                    matchesStatus = isLowStock;
                } else if (statusFilter === 'ok') {
                    matchesStatus = !isLowStock;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            refreshLowStockTable();
        }

        // 清空低库存搜索
        function clearLowStockSearch() {
            document.getElementById('lowStockSearchInput').value = '';
            document.getElementById('lowStockStatusFilter').value = '';
            filteredLowStockProducts = [];
            refreshLowStockTable();
        }

        // 重写refreshLowStockTable函数以支持搜索过滤
        function refreshLowStockTable() {
            const table = document.getElementById('lowStockTable');
            table.innerHTML = '';

            // 使用过滤后的产品列表，如果没有过滤则使用所有产品
            const productsToShow = filteredLowStockProducts.length > 0 ? filteredLowStockProducts : products;

            if (productsToShow.length === 0) {
                const searchTerm = document.getElementById('lowStockSearchInput').value;
                const statusFilter = document.getElementById('lowStockStatusFilter').value;
                
                let message = 'No products found';
                if (searchTerm || statusFilter) {
                    message = 'No products match your search criteria';
                }
                
                table.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }

            productsToShow.forEach(product => {
                const threshold = lowStockThresholds[product.barcode] || 10;
                const isLowStock = product.quantity <= threshold;
                const statusClass = isLowStock ? 'low-stock-warning' : 'low-stock-ok';
                const statusText = isLowStock ? 'Low Stock' : 'OK';

                const row = `
                    <tr>
                        <td><strong>${product.barcode}</strong></td>
                        <td>${product.name}</td>
                        <td>${product.quantity}</td>
                        <td>
                            <input type="number" 
                                   class="threshold-input" 
                                   value="${threshold}" 
                                   min="0"
                                   onchange="updateProductThreshold('${product.barcode}', this.value)">
                        </td>
                        <td class="${statusClass}">${statusText}</td>
                        <td>
                            <button class="btn btn-primary" onclick="setProductThreshold('${product.barcode}')" style="padding: 4px 8px; font-size: 0.8rem;">
                                <i class="fas fa-save"></i>
                            </button>
                        </td>
                    </tr>
                `;
                table.innerHTML += row;
            });

            // 显示搜索结果统计
            updateLowStockSearchStats();
        }

        // 更新低库存搜索统计信息
        function updateLowStockSearchStats() {
            const searchTerm = document.getElementById('lowStockSearchInput').value;
            const statusFilter = document.getElementById('lowStockStatusFilter').value;
            const productsToShow = filteredLowStockProducts.length > 0 ? filteredLowStockProducts : products;
            
            let statsText = `Showing ${productsToShow.length} of ${products.length} products`;
            
            if (searchTerm || statusFilter) {
                let filterText = [];
                if (searchTerm) filterText.push(`search: "${searchTerm}"`);
                if (statusFilter) filterText.push(`status: ${statusFilter}`);
                statsText += ` (filtered by ${filterText.join(', ')})`;
            }
            
            // 在表格上方显示统计信息
            const statsElement = document.querySelector('.product-settings h3');
            if (statsElement) {
                statsElement.innerHTML = `Individual Product Settings <span style="font-size: 0.9em; color: #6b7280; font-weight: normal;">(${statsText})</span>`;
            }
        }

        // 用户管理相关函数
        // 显示用户管理模态框
        function showUserManagement() {
            document.getElementById('userManagementModal').style.display = 'block';
            loadUsers();
        }

        // 关闭用户管理模态框
        function closeUserManagement() {
            document.getElementById('userManagementModal').style.display = 'none';
        }

        // 加载用户列表
        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE}/users`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayUsers(result.data);
                } else {
                    showNotification('Failed to load user list: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load user list, please check network connection', 'error');
            }
        }

        // 显示用户列表
        function displayUsers(users) {
            const table = document.getElementById('userTable');
            table.innerHTML = '';

            if (users.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const isDefaultUser = ['root', 'admin', 'user'].includes(user.username);
                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${getRoleText(user.role)}</td>
                        <td>${user.created_at}</td>
                        <td class="user-actions-cell">
                            ${isDefaultUser ? 
                                '<span style="color: #6b7280; font-size: 12px;">Default user</span>' : 
                                `<button class="btn btn-danger" onclick="deleteUser(${user.id})" style="padding: 4px 8px; font-size: 0.8rem;">
                                    <i class="fas fa-trash"></i>
                                </button>`
                            }
                        </td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }

        // 获取角色文本
        function getRoleText(role) {
            switch (role) {
                case 'root': return 'Root Admin';
                case 'admin': return 'Admin Admin';
                case 'user': return 'User User';
                default: return role;
            }
        }

        // 显示添加用户表单
        function showAddUserForm() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        // 关闭添加用户模态框
        function closeAddUser() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newRole').value = '';
        }

        // 添加用户
        async function addUser() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            if (!username || !password || !role) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ username, password, role })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('User added successfully');
                    closeAddUser();
                    loadUsers();
                } else {
                    showNotification('Add user failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Add user failed, please check network connection', 'error');
            }
        }

        // 删除用户
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('User deleted successfully');
                    loadUsers();
                } else {
                    showNotification('Delete user failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Delete user failed, please check network connection', 'error');
            }
        }

        // 显示修改密码模态框
        function showChangePassword() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        // 关闭修改密码模态框
        function closeChangePassword() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPasswordChange').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // 修改密码
        async function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPasswordChange').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('New password and confirm password do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Password changed successfully');
                    closeChangePassword();
                } else {
                    showNotification('Change password failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showNotification('Change password failed, please check network connection', 'error');
            }
        }

        // 更新API调用以包含认证头
        async function loadProducts() {
            try {
                showNotification('Loading product data...', 'info');
                const response = await fetch(`${API_BASE}/products`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const result = await response.json();
                if (result.success) {
                    products = result.data;
                    filteredProducts = [...products];
                    refreshTable();
                    updateStats();
                    showNotification('Product data loaded successfully');
                } else {
                    showNotification('Failed to load product: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showNotification('Error loading product, please check your network connection', 'error');
            }
        }

        // 更新其他API调用
        async function addProduct() {
            const barcode = document.getElementById("barcode").value.trim();
            const name = document.getElementById("name").value.trim();
            const category = document.getElementById("category").value;
            const cost_price = parseFloat(document.getElementById("cost_price").value);
            const selling_price = parseFloat(document.getElementById("selling_price").value);
            const quantity = parseInt(document.getElementById("quantity").value);

            if (!barcode || !name || !category || isNaN(cost_price) || isNaN(selling_price) || isNaN(quantity)) {
                showNotification("Please fill in all required fields", "error");
                return;
            }

            if (cost_price > selling_price) {
                showNotification("Cost price cannot be higher than selling price", "error");
                return;
            } 

            if (quantity < 0) {
                showNotification("Stock quantity cannot be negative", "error");
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        barcode, name, category, quantity, cost_price, selling_price
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadProducts(); // 重新加载产品数据
                    clearInputs();
                    showNotification("Product added successfully!");
                } else {
                    showNotification("Add failed: " + result.error, "error");
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showNotification("Error adding product, please check your network connection", "error");
            }
        }

        async function modifyProduct() {
            if (selectedRowId === null) {
                showNotification("Please select the product to modify", "error");
                return;
            }

            const barcode = document.getElementById("barcode").value.trim();
            const name = document.getElementById("name").value.trim();
            const category = document.getElementById("category").value;
            const cost_price = parseFloat(document.getElementById("cost_price").value);
            const selling_price = parseFloat(document.getElementById("selling_price").value);
            const quantity = parseInt(document.getElementById("quantity").value);

            if (!barcode || !name || !category || isNaN(cost_price) || isNaN(selling_price) || isNaN(quantity)) {
                showNotification("Please fill in all required fields", "error");
                return;
            }

            if (cost_price > selling_price) {
                    showNotification("Cost price cannot be higher than selling price", "error");
                return;
            }

            try {
                const productId = filteredProducts[selectedRowId].id;
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        barcode, name, category, quantity, cost_price, selling_price
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadProducts(); // 重新加载产品数据
                    clearInputs();
                    showNotification("Product modified successfully!");
                } else {
                    showNotification("Modify failed: " + result.error, "error");
                }
            } catch (error) {
                console.error('Error modifying product:', error);
                showNotification("Error modifying product, please check your network connection", "error");
            }
        }

        async function deleteProduct() {
            if (selectedRowId === null) {
                showNotification("Please select the product to delete", "error");
                return;
            }

            if (!confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
                return;
            }

            try {
                const productId = filteredProducts[selectedRowId].id;
                const response = await fetch(`${API_BASE}/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const result = await response.json();
                if (result.success) {
                    await loadProducts(); // 重新加载产品数据
                    clearInputs();
                    showNotification("Product deleted successfully!");
                } else {
                    showNotification("Delete failed: " + result.error, "error");
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showNotification("Error deleting product, please check your network connection", "error");
            }
        }


    </script>
</body>
</html>
